name: Update CSVs and upload to R2

on:
  schedule:
    # 04:45 UTC = 12:45 AM ET (daylight); safe window after GA's 11:34 PM ET draw
    - cron: '45 4 * * *'
  workflow_dispatch: {}

permissions:
  contents: write  # allow commit back to repo if files changed

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run updater
        run: node scripts/update_csvs.mjs

      - name: Commit changes (if any)
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add public/data/ga/*.csv
            git commit -m "chore: update CSVs"
            git push
          else
            echo "No CSV changes to commit."
          fi
      - name: Wrangler version
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: --version

      # Quick sanity check: fail early if any secret is missing
      - name: Verify required secrets are present
        run: |
          [ -z "${{ secrets.CF_ACCOUNT_ID }}" ] && echo "CF_ACCOUNT_ID is MISSING" && exit 1 || echo "CF_ACCOUNT_ID is set"
          [ -z "${{ secrets.CF_API_TOKEN }}" ] && echo "CF_API_TOKEN is MISSING" && exit 1 || echo "CF_API_TOKEN is set"
          [ -z "${{ secrets.R2_BUCKET }}" ] && echo "R2_BUCKET is MISSING" && exit 1 || echo "R2_BUCKET is set"

      # Optional: show what we're about to upload
      - name: Show Fantasy 5 CSV (before upload)
        run: |
          sed -n '1,20p' public/data/ga/fantasy5.csv || true
          wc -l public/data/ga/fantasy5.csv || true


      # Smoke test Wrangler auth + bucket visibility
      - name: List R2 buckets
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: r2 bucket list
    

      # ✅ Upload Fantasy 5 (note: no leading slash, no --force)
      - name: Upload Fantasy 5 to R2
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: r2 object put ${{ secrets.R2_BUCKET }}/ga/fantasy5.csv --file=public/data/ga/fantasy5.csv --content-type text/csv


      # ✅ Upload Cash4Life
      - name: Upload Cash4Life to R2
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: r2 object put ${{ secrets.R2_BUCKET }}/ga/cash4life.csv --file=public/data/ga/cash4life.csv --content-type text/csv